<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oldstuff.cola.goods.mapper.GoodsMapper">

<!--    <select id="getRandom" resultType="com.oldstuff.pojo.vo.GoodsRandomVO">-->
<!--        select id, name, fineness_id, price, poster from goods order by rand() limit 4-->
<!--    </select>-->

    <select id="getGoodsListByMarket" resultMap="GoodsDTOResultMap">
        SELECT *
        FROM goods
        <where>
            <!-- 商品名称模糊查询 -->
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>

            <!-- 商品类型 -->
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>

            <!-- 商品分类 -->
            <if test="categoryId != null">
                AND category_id = #{categoryId}
            </if>

            <!-- 成色分类 -->
            <if test="finenessId != null">
                AND fineness_id = #{finenessId}
            </if>

            <!-- 价格区间 -->
            <if test="minPrice != null">
                AND price &gt;= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice}
            </if>
        </where>

        <!-- 排序 -->
        <choose>
            <when test="priceSort != null and priceSort != 'NONE'">
                ORDER BY price
                <choose>
                    <when test="priceSort == 'ASC'">ASC</when>
                    <when test="priceSort == 'DESC'">DESC</when>
                </choose>
            </when>
            <when test="createTimeSort != null and createTimeSort != 'NONE'">
                ORDER BY create_time DESC
            </when>
            <when test="likeSort != null and likeSort != 'NONE'">
                ORDER BY likes DESC
            </when>
        </choose>

        <!-- 分页 -->
        <if test="page != null and pageSize != null">
            LIMIT #{pageSize} OFFSET #{page} * #{pageSize}
        </if>
    </select>

    <resultMap id="GoodsDTOResultMap" type="com.oldstuff.cola.dto.data.goods.GoodsDTO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="type" column="type"/>
        <result property="categoryId" column="category_id"/>
        <result property="finenessId" column="fineness_id"/>
        <result property="poster" column="poster"/>
        <result property="price" column="price"/>
        <result property="originalPrice" column="original_price"/>
        <result property="description" column="description"/>
        <result property="want" column="want"/>
        <result property="views" column="views"/>
        <result property="likes" column="likes"/>
        <result property="createdAt" column="created_at"/>
        <result property="finishStatus" column="finish_status"/>
        <result property="nums" column="nums"/>
        <result property="freeShip" column="free_ship"/>
        <result property="deliveryProvinceName" column="delivery_province_name"/>

        <!-- 商品预览图列表 -->
        <collection property="images" ofType="java.lang.String" column="images" javaType="ArrayList"/>

        <!-- 发布人信息 -->
        <association property="user" javaType="com.oldstuff.cola.dto.data.goods.GoodsMerchantDTO">
            <id property="id" column="user_id"/>
            <result property="name" column="user_name"/>
            <result property="avatar" column="user_avatar"/>
            <result property="score" column="user_score"/>
            <result property="orderNum" column="user_order_num"/>
            <result property="lastReply" column="user_last_reply"/>
            <result property="replyRate" column="user_reply_rate"/>
        </association>
    </resultMap>


</mapper>
